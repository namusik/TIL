# Transactrion

## 개념
- 데이터베이스에서 하나의 거래를 안전하게 처리하도록 보장해주는 것

## 트랜잭션 ACID

1. 원자성 Atomicity
   1. 같은 트랜잭션 내에서 실행한 작업들은 모두 성공하거나 모두 실패하거나
2. 일관성 Consistency
   1. 일관성있는 데이터베이스 상태 유지
3. 격리성 Isolation
   1. 트랜잭션들이 서로에게 영향을 미치면 안된다.
   2. Isolation Level 4단계
4. 지속성 Durability
   1. 성공적으로 끝내고 결과를 기록해야 한다.

## 트랜잭션 흐름

![dbsession](../Images/DB/dbsession.png)

- 서버가 DB와 커넥션 연결 -> DB 내부에 세션생성 -> 세션이 트랜잭션 시작 -> SQL 구문 실행 -> commit/rollback으로 트랜잭션 종료

## 트랜잭션 사용법

- commit
  - 데이터베이스에 변경 반영
- rollback
  - 데이터베이스에 변경 반영x
- 즉, commit을 호출하기 전에는 실제로 반영되는 것이 아니라 해당 세션에만 임시로 데이터를 저장해두는 것이다.
  - 다른 세션에서는 해당 변경이 보이지 않는다.


## DB Lock(락)

- 원자성을 지키기 위해 필요하다.
- 같은 데이터를 세션1이 수정하는 동안, 세션2가 수정하지 못하도록 하는 설정

### 동작 방식

- 세션1이 트랜잭션을 시작하면, 해당 row에 Lock을 먼저 획득한다.
- 세션2도 동일한 row에 수정을 하려하지만, Lock이 없기 때문에 세션1이 트랜잭션을 끝내고 Lock을 반납할 때까지 기다려야 한다.
  - 이때, 무한히 대기하는 것은 아니고 락 대기시간을 넘어서면 락 타임아웃 오류 발생. 설정을 통해 조절할 수 있다.


### 조회 Lock
- 조회 쿼리에도 Lock이 필요한 경우가 있다.
  - 특정 값을 조회해서 어떠한 로직을 수행한다면, 계산이 완료될 때 까지는, 다른 세션에서 해당 값을 변경해서는 안된다.
- 조회 쿼리에도 Lock을 주고 싶으면 `select for update` 쿼리를 사용하면 된다.
