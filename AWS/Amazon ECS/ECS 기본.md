# ECS (Amazon Elastic Container Service)

## 개념

**완전 관리형 컨테이너 오케스트레이션 서비스**

Docker 컨테이너를 실행하고 관리할 수 있도록 설계되었으며, 애플리케이션을 손쉽게 배포, 관리, 확장할 수 있도록 지원

ECS는 서버리스 방식으로 동작하거나 EC2 인스턴스에서 컨테이너를 실행가능

## 주요 특징:

1. 완전 관리형 서비스: 
   1. ECS는 컨테이너 오케스트레이션을 자동으로 관리하며, 사용자는 인프라 관리 부담을 덜 수 있습니다. 
   2. 클러스터 구성과 클러스터 내부 컨테이너 실행,중지,배포 모니터링 가능
2. EC2 및 Fargate 지원:
   1. EC2 모드: 사용자가 직접 EC2 인스턴스를 관리하면서 컨테이너를 배포.
   2. Fargate 모드: 서버리스 방식으로, 사용자가 인프라를 관리하지 않아도 컨테이너를 실행할 수 있습니다.
3.	통합된 AWS 서비스: ECS는 Amazon VPC, ELB(Elastic Load Balancing), IAM, CloudWatch 등과 통합되어 보안, 네트워킹, 모니터링 등을 간편하게 설정할 수 있습니다.
4.	Auto Scaling: 필요에 따라 컨테이너 인스턴스를 자동으로 확장하거나 축소할 수 있습니다.
5.	유연한 작업 스케줄링: 사용자는 지정한 작업(Tasks)을 원하는 방식으로 실행할 수 있으며, 단일 작업 실행, 예약 작업, 지속적인 서비스 실행 등을 지원합니다.
6.	보안: IAM 역할을 통해 세밀한 권한 제어를 제공하고, 컨테이너 간 네트워크 통신을 보호합니다.

## ECS 구성 요소:

![ecsframe](../../images/AWS/ecsframe.png)

### ECS 클러스터(Cluster)

-	정의: ECS 클러스터는 **ECS 작업(Task)을 실행하기 위한 논리적 그룹**입니다.
- 구성:
  -	컨테이너 인스턴스(Container Instance): 클러스터 내에서 작업을 실행하는 EC2 인스턴스 또는 Fargate 인프라.
  -	작업(Task): 태스크 정의에 기반하여 실행되는 컨테이너 인스턴스.
  -	서비스(Service): 특정 수의 작업을 지속적으로 실행하고 관리하는 구성 요소.

### 컨테이너 인스턴스(Container Instance)

-	정의: ECS 클러스터 내에서 태스크와 컨테이너를 실행하는 **EC2 인스턴스**.
- 구성:
  -	**EC2 인스턴스**: ECS 에이전트가 설치된 EC2 인스턴스로, **작업과 컨테이너를 실행**. 내부적으로 autoscaling 그룹으로 구성되어있음.
  -	**ECS 에이전트**: **인스턴스와 ECS 서비스 간의 통신을 담당하는 소프트웨어**.
    -	작업 상태 보고
    -	작업 배포 및 관리
  -	**Docker 데몬**: ECS가 컨테이너를 실행하고 관리할 수 있도록 지원.
  -	**IAM 역할**: 인스턴스가 AWS 리소스에 접근할 수 있도록 권한을 부여.
-	상태: 컨테이너 인스턴스는 등록 상태(Registered), 활성 상태(Active), 중지 상태(Deregistered)로 관리.

### 태스크 정의(Task Definition)

-	정의: 컨테이너를 실행하기 위한 **설정을 정의하는 JSON 템플릿**.
- 구성 요소:
  -	컨테이너 정의: 실행할 Docker 이미지, 메모리, CPU, 환경 변수, 네트워크 설정 등을 포함.
    - 이름:
      - 태스크 내의 고유한 컨테이너 이름  
    - 이미지(Image) URI:
      -	실행할 Docker 이미지의 이름과 태그를 지정합니다.
      -	예: nginx:latest, myapp:v1.0, 123456789012.dkr.ecr.us-west-2.amazonaws.com/my-app:latest
    - CPU 및 메모리(CPU and Memory):
      - 개별 컨테이너에 대한 세부적인 리소스 제약을 설정
      -	ECS에서 CPU와 메모리는 태스크 수준과 컨테이너 수준에서 설정할 수 있습니다.
    - 포트 매핑(Port Mappings):
      - 컨테이너 포트(Container Port)
        - 컨테이너 내부에서 애플리케이션이 수신 대기(listening)하는 포트
        - Docker 컨테이너 내에서 애플리케이션이 바인딩된 포트를 설정
      - 호스트 포트(Host Port)
        - 외부 트래픽이 호스트(EC2 인스턴스 또는 Fargate ENI)의 특정 포트로 들어올 때 컨테이너로 전달
        - 0: 동적으로 호스트 포트를 할당.
      -	컨테이너 포트를 호스트 포트 또는 awsvpc 네트워크 모드의 ENI에 매핑합니다.
      -	예: 컨테이너 포트 80을 호스트 포트 8080에 매핑.
    - 환경 변수(Environment Variables):
      -	컨테이너에 전달할 환경 변수를 설정합니다.
      -	예: 데이터베이스 연결 정보, 애플리케이션 설정 값.
    - 커맨드 및 엔트리포인트(Command and EntryPoint):
      -	컨테이너가 시작될 때 실행할 명령어와 엔트리포인트를 설정합니다.
    - 로깅(Logging):
      -	컨테이너에서 생성된 로그를 어디로 보낼지 정의합니다.
    -	Amazon CloudWatch Logs와의 통합을 설정하여 로그를 중앙에서 관리할 수 있습니다.
  - 볼륨 정의: 컨테이너 간 공유할 볼륨 설정.
  - 인프라 요구 사항
    - 태스크 크기
      - 태스크 전체(즉, 태스크 내 모든 컨테이너가 공유할 수 있는 리소스)의 CPU와 메모리를 정의
      - ECS 태스크와 컨테이너가 사용할 CPU와 메모리 자원을 제어
  - 네트워크 모드: 컨테이너의 네트워크 설정(bridge, host, awsvpc 등).
    - Bridge: Docker의 기본 브리지 네트워크 모드.
      - 컨테이너 포트와 호스트 포트를 매핑하여, 외부에서 호스트 시스템의 특정 포트로 접근하면 컨테이너의 지정된 포트로 트래픽이 전달
      - 예: 호스트 포트 8080을 컨테이너 포트 80으로 매핑하면, 외부 클라이언트가 http://<host-ip>:8080에 접속하면 컨테이너의 80 포트로 트래픽이 전달
    - Host: 
      - 컨테이너가 호스트와 동일한 네트워크 네임스페이스를 공유
      - 컨테이너 포트와 호스트 포트가 동일하게 설정되어야 하며, 포트 매핑이 필요하지 않습니다.
    - awsvpc: 
      - 컨테이너에 고유한 Elastic Network Interface(ENI)와 고유한 사설 IP 주소를 할당.
      - 컨테이너가 VPC 내에서 독립적으로 네트워크를 구성
      - 포트 매핑은 필요하지만, 컨테이너 포트와 ENI에 대한 포트 간 매핑이 이루어집니다.
    - None: 네트워크를 비활성화.

### 서비스(Service)

-	정의: 지속적으로 실행되어야 하는 **작업(Task)을 관리하는 ECS 구성 요소**.
- 기능:
  -	특정 수의 작업을 유지.
  -	실패한 작업을 재시작.
  -	Auto Scaling: 트래픽 변화에 따라 작업 수를 자동 조정.
  -	로드 밸런싱: **ELB(Elastic Load Balancer)를 사용하여 트래픽을 작업에 분산**.

### 작업(Task)

-	정의: 태스크 정의에 따라 실행되는 컨테이너 인스턴스.
- 구성:
  -	**하나 이상의 컨테이너가 포함**될 수 있음.
  -	특정 리소스(CPU, 메모리)를 할당받아 실행.
  -	작업이 실행되는 동안 ECS 클러스터와 통신하여 상태를 보고.