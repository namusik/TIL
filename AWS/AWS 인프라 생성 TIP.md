# AWS 인프라 생성 TIP

1. VPC
   1. VPC를 만들면 메인 라우팅 테이블이 자동으로 만들어짐
      1. 이 테이블은 모든 서브넷과 자동으로 연결됨
   2. 이 때 CIDR 설계를 잘 해야될듯?
2. 서브넷
   1. 이름지을 때, 가용영역 (a~d)에 따라서 서브넷 이름에도 a~d 적어주면 좋을 듯하다.
   2. private, public, rds 서브넷을 나눠주면 좋음.
3. 인터넷 게이트웨이
4. 라우팅 테이블
   1. 퍼블릭 테이블은 인터넷게이트웨이, 퍼블릿 서브넷 연결
   2. 프라이빗 테이블은 NAT 게이트웨이, 프라이빗 서브넷 연결
5. NAT 게이트웨이
   1. 퍼블릭 서브넷에 있어야 한다.
6. 보안그룹
   1. bastion 인스턴스 보안그룹
      1. SSH - 내 IP
   2. private 인스턴스 보안그룹
      1. SSH - bastion 인스턴스에 적용된 보안그룹을 선택
      2. HTTP/HTTPS alb 보안그룹을 소스로 인바운드 추가
      3. SSH - jenkins 인스턴스 보안그룹 추가
      4. 참고로 아웃바운드에는 모든 트래픽 허용이 열려있어야 함.
   3. alb 보안그룹
      1. HTTP, HTTPS Anywhere IPv4 inbound 설정 
   4. RDS 보안그룹
      1. bastion 서버 보안그룹, private app ec2 보안그룹 MYSQL/Aurora 유형 3306
      2. bastion 서버에서 3306 붙게 하는이유는 로컬 pc에서 db 접근할 때 bastion 서버에서 ssh tunnel로 db 접근하게 할 수 있음.
   5. jenkins 보안그룹
      1. SSH 22 소스 : bastion server 보안그룹
      2. TCP 8080 소스 : bastion server 보안그룹 젠킨스 서비스 포트 들어올 수 있게
      3. TCP 8080 소스 : alb 보안그룹, 젠킨스 서비스 포트 들어올 수 있게
7. 인스턴스
   1. bastion 인스턴스 
      1. public subnet에
      2. 탄력적 IP 할당 필요
      3. public 보안그룹 설정
   2. private app 인스턴스
      1. private subnet에
      2. private 보안그룹 설정
   3. openVpn 용 인스턴스
      1. openvpn API 사용해야 함. OpenVPN Access Server
      2. public subnet에
      3. 보안그룹 자동생성 그대고 사용
      4. 탄력적 IP 할당 필요
      5. SSH 붙고 나면 admin 주소를 받을 수 있음
   4. jenkins 용 인스턴스 
      1. private subnet에 설치
      2. jenkins 용 보안 그룹 선택
      3. private이기 때문데 alb에 8080 리스너로 들어오면 jenkins 인스턴스 8080으로 가도록 리스너와 대상그룹 추가 필요
   5. 시작 템플릿
      1. OS 이미지는 미리 만들어둔 AMI를 선택
      2. 인스턴스 유형도 선택
      3. 키페어 선택
      4. 서브넷은 private 서브넷 중에 하나에
      5. 보안그룹은 원본 ec2 보안그룹 선택
   6. 이미지 생성
      1. 인스턴스 재부팅 안되도록 체크 해제
8. 오토 스케일링
   1. 미리 만들어둔 시작템플릿 선택
   2. 버전도 주의해서 선택
   3. vpc 잘 선택
   4. 인스턴스가 올라간 private subnet 선택
   5. 기존 로드밸런서 잘 선택하고 대상그룹 잘 선택
   6. 상태확인 유예기간 10초로 수정
   7. 최대용량 3개로 수정
   8. 동적크기정책 생성
      1. 대상 추적 크기 조정
      2. 평균 CPU 사용률
      3. 70%
      4. 워밍업 시간 10초
   9.  Name 태그의 값이 인스턴스명으로 된다.
   10. 생성후, ec2가 생성되고 대상그룹에 추가된것을 확인 가능
   11. 스케일인 될때 대상그룹의 삭제 시간은 속성에서 드레이닝 간격 수치
9.  탄력적 IP
10. Route53
    1.  레코드 생성 
        1.  A 유형
        2.  별칭 선택해서 만든 로드밸런서 선택
11. ACM
    1.  Route53에서 등록한 도메인을 가지고 생성
    2.  보통 *.을 도메인 앞에 붙여서 등록
    3.  생성 후에 `Route53에서 레코드 생성` 클릭해서 인증
    4.  인증이 되면 Route53 호스팅 영역에 CNAME 유형의 DNS 레코드가 생성된다.
12. RDS
    1.  서브넷 그룹을 선택할 때, db 전용으로 만든 서브넷을 선택
    2.  데이터베이스 
        1.  EC2 연결 안함으로 선택
        2.  퍼블릭 액세스 아니요
        3.  서브넷 그룹 위에 만든 거 선택
        4. 기존에 만든 보안그룹 선택
13. 로드밸런서
    1.  대상 그룹
        1.	대상 그룹의 포트 설정: 기본적으로 ELB가 대상에게 트래픽을 전달할 때 사용할 포트. 하지만 대상 인스턴스를 등록할 때 별도로 포트를 지정하면, 이 설정은 무시됩니다.
	         등록된 대상의 포트 설정: 대상 인스턴스가 ELB로부터 트래픽을 받을 실제 포트. 대상 그룹의 기본값보다 우선 적용됩니다.
         2. 8080포트로 받는 대상그룹 만들 때, 상태검사 포트를 재정의해서 바꿔줘야 한다.
         3. vpc 잘 선택하기
         4. 상태검사 경로 잘 지정하기
   1. 로드밸런서
      1. 일반적으로 **퍼블릭 서브넷(Public Subnet)** 에 배치
      2. 로드밸런서 전용 보안그룹 선택
      3. 리스너 포트에 따라 대상그룹 선택
      4. ACM 인증서 선택
      5. 리스너 
         1. 80으로 들어온건 443 리다이렉션
         2. 443들어오는 거에 호스트 조건을 줄 수 도 있다. 일치하는 위에서 생성한 도메인만 받기위해.
            1. 아예 대상그룹을 8080으로 해서 프론트엔드가 아니라 백엔드 서버로 바로 붇는 도메인을 만들 수 도 잇다.
      6. 로드밸런서 DNS 주소를 사용해서 접속할 수 도 있음.
14. cloudfront
    1.  로드밸런서 용
        1.  글로벌 서비스이기 때문에 ACM을 버지니아 북부에서 만들어야함.
        2.  로드밸런서 선택
        3.  뷰어 프로토콜 : Redirect HTTP to HTTPS
        4.  대체 도메인 : 선택
        5.  ACM 인증서 선택
        6.  기존에 만들어진 도메인을 편집해서 트래픽 라우팅 대상을 cloudfront로 변경해야 됨.
    2.  s3 용
        1.  s3 버킷 선택
        2.  원본 액세스 제어 설정(권장)
            1.  새로 생성
        3.  뷰어 프로토콜 : Redirect HTTP to HTTPS
        4.  생성 후에 원본 > 편집 > 정책 복사 > S3 버킷 정책에 붙여넣기
        5.  x-cache: Hit from cloudfront --> 캐시 되고 있는 상태
        6.  한번 캐시되면 버킷에서 객체를 삭제해도 새로고침했을떄 사진이 계속 보임.
        7.  무효화 생성
            1.  객체 경로 : /*
        8.  무효화 하면 이제 캐시된 사진이 안나온다.
        9.  
15. s3 
    1.  cloudfront 배포 도메인이름/객체이름 으로 브라우저로 들어가면 된다.
