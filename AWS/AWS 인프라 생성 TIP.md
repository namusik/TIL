# AWS 인프라 생성 TIP

1. VPC
   1. VPC를 만들면 메인 라우팅 테이블이 자동으로 만들어짐
      1. 이 테이블은 모든 서브넷과 자동으로 연결됨
   2. 이 때 CIDR 설계를 잘 해야될듯?
2. 서브넷
   1. 이름지을 때, 가용영역 (a~d)에 따라서 서브넷 이름에도 a~d 적어주면 좋을 듯하다.
   2. private, public, rds 서브넷을 나눠주면 좋음.
3. 인터넷 게이트웨이
4. 라우팅 테이블
   1. 퍼블릭 테이블은 인터넷게이트웨이, 퍼블릿 서브넷 연결
   2. 프라이빗 테이블은 NAT 게이트웨이, 프라이빗 서브넷 연결
5. NAT 게이트웨이
   1. 퍼블릭 서브넷에 있어야 한다.
6. 보안그룹
   1. bastion 인스턴스 보안그룹
      1. SSH - 내 IP
   2. private 인스턴스 보안그룹
      1. SSH - bastion 인스턴스에 적용된 보안그룹을 선택
      2. HTTP/HTTPS alb 보안그룹을 소스로 인바운드 추가
      3. SSH - jenkins 인스턴스 보안그룹 추가
      4. 참고로 아웃바운드에는 모든 트래픽 허용이 열려있어야 함.
   3. alb 보안그룹
      1. HTTP, HTTPS Anywhere IPv4 inbound 설정 
   4. RDS 보안그룹
      1. bastion 서버 보안그룹, private app ec2 보안그룹 MYSQL/Aurora 유형 3306
      2. bastion 서버에서 3306 붙게 하는이유는 로컬 pc에서 db 접근할 때 bastion 서버에서 ssh tunnel로 db 접근하게 할 수 있음.
   5. jenkins 보안그룹
      1. SSH 22 소스 : bastion server 보안그룹
      2. TCP 8080 소스 : bastion server 보안그룹 젠킨스 서비스 포트 들어올 수 있게
      3. TCP 8080 소스 : alb 보안그룹, 젠킨스 서비스 포트 들어올 수 있게
   6. ECS 보안 그룹 
      1. 모든 TCP : 로드밸런서 보안그룹 소스
         1. ECS에서 동적 포트를 사용하기 때문에.
      2. RDS 보안그룹에 ECS 보안그룹을 소스로 하는 3306 열어두기
7. 인스턴스
   1. bastion 인스턴스 
      1. public subnet에
      2. 탄력적 IP 할당 필요
      3. public 보안그룹 설정
   2. private app 인스턴스
      1. private subnet에
      2. private 보안그룹 설정
   3. openVpn 용 인스턴스
      1. openvpn API 사용해야 함. OpenVPN Access Server
      2. public subnet에
      3. 보안그룹 자동생성 그대고 사용
      4. 탄력적 IP 할당 필요
      5. SSH 붙고 나면 admin 주소를 받을 수 있음
   4. jenkins 용 인스턴스 
      1. private subnet에 설치
      2. jenkins 용 보안 그룹 선택
      3. private이기 때문데 alb에 8080 리스너로 들어오면 jenkins 인스턴스 8080으로 가도록 리스너와 대상그룹 추가 필요
   5. 시작 템플릿
      1. OS 이미지는 미리 만들어둔 AMI를 선택
      2. 인스턴스 유형도 선택
      3. 키페어 선택
      4. 서브넷은 private 서브넷 중에 하나에
      5. 보안그룹은 원본 ec2 보안그룹 선택
   6. 이미지 생성
      1. 인스턴스 재부팅 안되도록 체크 해제
8. 오토 스케일링
   1. 미리 만들어둔 시작템플릿 선택
   2. 버전도 주의해서 선택
   3. vpc 잘 선택
   4. 인스턴스가 올라간 private subnet 선택
   5. 기존 로드밸런서 잘 선택하고 대상그룹 잘 선택
   6. 상태확인 유예기간 10초로 수정
   7. 최대용량 3개로 수정
   8. 동적크기정책 생성
      1. 대상 추적 크기 조정
      2. 평균 CPU 사용률
      3. 70%
      4. 워밍업 시간 10초
   9.  Name 태그의 값이 인스턴스명으로 된다.
   10. 생성후, ec2가 생성되고 대상그룹에 추가된것을 확인 가능
   11. 스케일인 될때 대상그룹의 삭제 시간은 속성에서 드레이닝 간격 수치
9.  탄력적 IP
10. Route53
    1. 백엔드 용 route53
        1.  A 유형
        2.  로드밸런서 선택
    2.  프론트엔드 홈페이지 용 route53
        1.  A 유형
        2.  만들어둔 로드밸런서용 cloudfront 선택 혹은 바로 alb 선택
11. ACM
    1.  Route53에서 등록한 도메인을 가지고 생성
    2.  보통 *.을 도메인 앞에 붙여서 등록
    3.  생성 후에 `Route53에서 레코드 생성` 클릭해서 인증
    4.  인증이 되면 Route53 호스팅 영역에 CNAME 유형의 DNS 레코드가 생성된다.
12. RDS
    1.  서브넷 그룹을 선택할 때, db 전용으로 만든 서브넷을 선택
    2.  데이터베이스 
        1.  EC2 연결 안함으로 선택
        2.  퍼블릭 액세스 아니요
        3.  서브넷 그룹 위에 만든 거 선택
        4. 기존에 만든 보안그룹 선택
13. 로드밸런서
    1.  대상 그룹
        1.  대상 그룹의 포트 설정: 기본적으로 ELB가 대상에게 트래픽을 전달할 때 사용할 포트. 하지만 대상 인스턴스를 등록할 때 별도로 포트를 지정하면, 이 설정은 무시됩니다. 등록된 대상의 포트 설정: 대상 인스턴스가 ELB로부터 트래픽을 받을 실제 포트. 대상 그룹의 기본값보다 우선 적용됩니다.
        2.  8080포트로 받는 대상그룹 만들 때, 상태검사 포트를 재정의해서 바꿔줘야 한다.ㅂ
        3.  vpc 잘 선택하기
        4.  상태검사 경로 잘 지정하기
    2.  EC2 연결 로드밸런서
        1.  일반적으로 **퍼블릭 서브넷(Public Subnet)** 에 배치
        2.  로드밸런서 전용 보안그룹 선택
        3.  리스너 포트에 따라 대상그룹 선택
        4.  ACM 인증서 선택
        5.  리스너 
            1.  80으로 들어온건 443 리다이렉션
            2.  443들어오는 거에 호스트 조건을 줄 수 도 있다. 일치하는 위에서 생성한 도메인만 받기위해.
            3.  아예 대상그룹을 8080으로 해서 프론트엔드가 아니라 백엔드 서버로 바로 붇는 도메인을 만들 수 도 잇다.
            4.  로드밸런서 DNS 주소를 사용해서 접속할 수 도 있음.
    3.  ECS 연결 로드 밸런서
        1.  ECS 대상그룹
            1.  인스턴스 선택
            2.  80포트 대상그룹
            3.  8080포트 대상그룹
                1.  헬스체크 경로는 백엔드 코드에 맞게
        2.  리스너
            1.  HTTP / 80 리스너 
                1.  443으로 리다이렉션
            2.  HTTPS / 443 리스너
                1.  80 대상그룹
                2.  호스트 헤더가 api 주소일 때 8080 대상그룹으로
            3.  ACM 선택해주기
14. cloudfront
    1.  로드밸런서 용
        1.  글로벌 서비스이기 때문에 ACM을 버지니아 북부에서 만들어야함.
        2.  로드밸런서 선택
        3.  뷰어 프로토콜 : Redirect HTTP to HTTPS
        4.  대체 도메인 : 선택
        5.  ACM 인증서 선택
        6.  기존에 만들어진 도메인을 편집해서 트래픽 라우팅 대상을 cloudfront로 변경해야 됨.
    2.  s3 용
        1.  s3 버킷 선택
        2.  원본 액세스 제어 설정(권장)
            1.  새로 생성
        3.  뷰어 프로토콜 : Redirect HTTP to HTTPS
        4.  생성 후에 원본 > 편집 > 정책 복사 > S3 버킷 정책에 붙여넣기
        5.  x-cache: Hit from cloudfront --> 캐시 되고 있는 상태
        6.  한번 캐시되면 버킷에서 객체를 삭제해도 새로고침했을떄 사진이 계속 보임.
        7.  무효화 생성
            1.  객체 경로 : /*
        8.  무효화 하면 이제 캐시된 사진이 안나온다.
        9.  
15. s3 
    1.  cloudfront 배포 도메인이름/객체이름 으로 브라우저로 들어가면 된다.
16. ECR 
    1. 프라이빗 리포지토리 생성
    2. 푸시명령어 보기
    3. ECR 명령어로 로그인이 안될 때 <임시 자격 증명 비활성화> 해줄 필요가 있음.
17. cloud9
    1.  환경생성
    2.  새로운 인스턴스
    3.  프라이빗 서브넷에 설치하기
    4.  연결 - SSM
    5.  ide 브라우저 연결가능
18. ECS
    1.  클러스터 생성
        1.  EC2 인스턴스 선택
        2.  프로비저닝 모델 : 온디맨드
        3.  EC2 역할 : 새로 생성
        4.  최소 개수 선택
        5.  키페어 선택
        6.  vpc와 private subnet 2개 선택
        6.  미리 만든 ecs용 sg 선택
    2.  최소 컨테이너 인스턴스들이 자동으로 생성됨
    3.  auto scaling group과 인스턴스들이 자동생성됨
    4.  태스크 정의 생성
        1. 프론트 엔드 컨테이너 세부 정보
           1. 이미지 URI == ECR 주소 입력
           2. 컨테이너 포트 : 80. 로드밸런서의 80 대상그룹이 일로 온다.
           3. 인프라 : EC2
           4. CPU 크기 지우고 메모리 1GB
           5. 태스크 역할 없음
           6. 태스크 실행 역할 : 새 역할 생성
        2. 백엔드 컨테이너 세부 정보
            1. 컨테이너 포트 : 8080 스프링부트 포트로 가도록
         3. 태스크 정의의 메모리 설정이 클러스터 ec2 스펙보다 높으면 서비스 생성할 때 오류 발생
    5. 프론트엔드 서비스 생성
       1. 시작 유형 : EC2 선택
       2. 태스크 정의 : 패밀리 : 미리 만들어둔 태스크 정의 선택
       3. 서비스 이름 설정
       4. 태스크 수 : 2
       5. 로드밸런싱
          1. ALB 선택
          2. 미리 만들어둔 alb 선택
          3. 태스크 정의에 속한 컨테이너 선택
          4. 새 리스너 포트 80 HTTP
          5. 기존에 frontend용 대상그룹 선택
19. codebuild
    1.  프로젝트 만들기
        1.  소스 : github 선택
        2.  개인용 액세스 토큰 저장해서 깃헙 리포지토리 url 입력
        3.  관리형 이미지 선택
            1.  도커 이미지 빌드 권한 체크
            2.  새 서비스 역할
        4.  buildspec 파일 사용
    2.  IAM 역할 확인하기 
        1. 위에 생성된 역할에 EC2InstanceProfileForImageBuilderECRContainerBuilds 정책  추가
     3. 빌드 시작
     4. ecr에 push 됐는지 확인
20. codeDeploy
    1.  ecs cluster 배포를 위한 IAM 역할 생성
        1.  aws 서비스 선택
        2.  사용 사례 : CodeDeploy - ECS 선택
        3.  권한 그대로
        4.  역할 이름 설정
    2. blue/green 배포를 위한 대상그룹 생성
       1. 인스턴스 선택
       2. vpc 선택
    3. 로드밸런서에 대상그룹 추가
       1. HTTPS : 8443 
       2. 위에서 만든 대상그룹 설정
    4. 로드밸런서 보안그룹에 8443 허용
    5. ECS 서비스 생성
       1. 시작유형 : ec2
       2. frontend 작업 정의 선택
       3. 배포옵션 : blue/green
       4. codedeploy 서비스 역할 위에 만든 거 선택
       5. 프로덕션리스너 포트 : HTTPS 443 선택
       6. 테스트 리스커 포트 : HTTPS 8443 선택
    6. S3 생성
       1. appspec.yml 파일 업로드
    7. codedeploy
       1. 애플리케이션 선택
       2. 배포만들기
          1. 배포 그룹 선택
          2. 애플리케이션 s3 저장
          3. 위에서 만든 s3 파일 uri 복붙
          4. 파일 형식 : .yaml
21. codepipleline
     1.  태스크 정의 json을 파일로 만들어두기
     2.  buildspec.yml에 artifacts에 위 json 추가하기
     3.  파이프라인 생성
         1.  소스공급자 : github 버전2
         2.  빌드공급자 : codebuild 선택
         3.  배포공급자 : ecs blue/green 선택
             1.  code deploy 선택
             2.  배포 그룹 선택
             3.  ecs 작업정의 : 위에 만든 json 이름 taskdef.json
             4.  appspec : appspec.yaml
22. cloudtrail
    1.  추적 생성
        1.  새 s3 버킷 선택
        2.  로그 파일 암호화 해제
        3.  나머지 기본값
        4.  추적과 s3가 생성됨.
    2.  이벤트 기록
        1.  아테나 테이블 생성
            1.  위의 s3 선택
23. athena
    1.  쿼리 편집기
        1.  default 데이터베이스 선택
        2.  테이블이 생성되어있음.
        3.  쿼리 결과 위치 선택
            1.  결과 버킷이 미리 만들어져 있음 aws-athena-query-results-854013278161-ap-northeast-2
            2.  객체 선택
        4.  쿼리 실행
24. alb 액세스 로그
    1.  모니터링 액세스 로그 활성화
    2.  mz-app-alb-logs 새로 입력
        1.  버킷에 정책 추가
        2.  싸이트 접속해보면 로그가 쌓이는 것을 확인
    3. 아테나 테이블 생성
       1. 예시 쿼리 사용해서 테이블 생성
25. vpc flow 로그
    1.  vpc > flow log 생성
    2.  대상 : s3
    3.  집계간격 1분
    4.  아테나 테이블 생성
        1.  쿼리 생성할 떄 파티션 생성 쿼리도 해줘야됨.
26. aws backup
    1.  볼트 생성
        1.  백업 볼트 선택
        2.  암호화 키 : aws/backup 기본값 선택
    2.  온디맨드 백업 생성
        1.  ec2 선택
        2.  백업 볼트 선택
        3.  iam 역할 기본 선택
        4.  볼트 복구시점과 작업 탭에서 확인가능
        5.  인스턴스 이미지에서 자동 생성
        6.  ec2 스냅샷에도 자동 생성
    3.  백업 복원
        1.  볼트 > 복구 시점 선택 후 작업 > 복원 선택
        2.  인스턴스 : t2 micro
        3.  vpc, 서브넷, 보안그룹 그대로 선택
        4.  복원하면 인스턴스가 생성됨.
    4.  EBS 볼륨 백업
        1.  대시보드 > 온디맨드 백업 생성
        2.  EBS 볼륨 선택
        3.  스냅샷에 자동 생성됨
    5.  EBS 복원
        1.  크기 선택
        2.  가용영역 선택
    6.  EBS 볼륨 붙이기
        1.  인스턴스 중지 
        2.  기존 볼륨 선택 후, 볼륨 분리
        3.  복원한 볼륨 선택 후, 볼륨 연결. 
            1. 인스턴스 선택
     7.  RDS 백업
         1.  온디맨드 백업 생성
         2.  RDS 선택
         3.  백업 볼트 선택
         4.  백업 생성
         5.  RDS > 스냅샷 > 백업 서비스 에서 생성 확인 가능
         6.  RDS 정지된 경우에는 백업 실패
         7.  또는 RDS 유지관리 및 백업 탭 > 백업 기간이 현재시간과 너무 가까우면 백업 볼트 실패
     8.  RDS 복원
         1.  인스턴스 클래스 선택 
         2.  스토리지 유형 : gp2
         3.  vpc, 서브넷 그룹 선택
         4.  RDS 에서 생성 확인
             1.  보안 그룹 수정 필요
27. cloudwatch
    1. 인스턴스에 cloudwatch agent 설치
    2. iam 역할 생성
       1. ec2 선택
       2. `CloudWatchAgentServerPolicy` 선택
       3. 역할 생성
       4. 인스턴스 > 작업 > 보안 > IAM 역할 수정 > 위에서 만든 역할 추가 
    3. 대시보드 생성
       1. cloudwatch > 지표 > 행 선택 > 
       2. 특정 지표 선택 > 위젯 생성
       3. 지표 > 게이지 > 최소 0 최대20
       4. 편집 > 최소값 0 설정 가능
       5. 기타 콘텐츠 유형 > 텍스트 로 제목칸도 만들 수 있음.
    4. 경보 생성
       1. 지표선택 > ec2 > CPUUtilization
       2. 통계 : 평균, 기간 : 5분 임계치 : 정적 70 보다 큼
       3. 새 주제 생성
          1. 이름, 이메일 설정
          2. 주제 생성
             1. 이메일 인증 해야됨
          3. 경보이름 설정